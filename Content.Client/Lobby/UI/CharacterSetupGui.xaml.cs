using Content.Client.Info;
using Content.Client.Info.PlaytimeStats;
using Content.Client.Resources;
using Content.Shared.CCVar;
using Content.Shared.Preferences;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;

namespace Content.Client.Lobby.UI
{
    /// <summary>
    /// Holds the entire character setup GUI, from character picks to individual character editing.
    /// </summary>
    [GenerateTypedNameReferences]
    public sealed partial class CharacterSetupGui : Control
    {
        [Dependency] private readonly IClientPreferencesManager _preferencesManager = default!;
        [Dependency] private readonly IEntityManager _entManager = default!;
        [Dependency] private readonly IPrototypeManager _protomanager = default!;
        [Dependency] private readonly IResourceCache _resourceCache = default!;
        [Dependency] private readonly IConfigurationManager _cfg = default!;

        private readonly Button _createNewCharacterButton;
        private readonly HumanoidProfileEditor _humanoidProfileEditor;
        private readonly JobPriorityEditor _jobPriorityEditor;
        public int? SelectedCharacterSlot;

        public event Action<int>? SelectCharacter;
        public event Action<int>? DeleteCharacter;
        public event Action<(int, bool)>? SetCharacterEnable;

        public CharacterSetupGui(HumanoidProfileEditor profileEditor, JobPriorityEditor jobPriorityEditor)
        {
            _humanoidProfileEditor = profileEditor;
            _jobPriorityEditor = jobPriorityEditor;
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);

            var panelTex = _resourceCache.GetTexture("/Textures/Interface/Nano/button.svg.96dpi.png");
            var back = new StyleBoxTexture
            {
                Texture = panelTex,
                Modulate = new Color(37, 37, 42)
            };
            back.SetPatchMargin(StyleBox.Margin.All, 10);

            BackgroundPanel.PanelOverride = back;

            _createNewCharacterButton = new Button
            {
                Text = Loc.GetString("character-setup-gui-create-new-character-button"),
            };

            _createNewCharacterButton.OnPressed += args =>
            {
                _preferencesManager.CreateCharacter(HumanoidCharacterProfile.Random());
                ReloadCharacterPickers();
                args.Event.Handle();
            };

            CharEditor.AddChild(profileEditor);
            JobPriorityEditor.AddChild(jobPriorityEditor);
            RulesButton.OnPressed += _ => new RulesAndInfoWindow().Open();

            StatsButton.OnPressed += _ => new PlaytimeStatsWindow().OpenCentered();

            _cfg.OnValueChanged(CCVars.SeeOwnNotes, p => AdminRemarksButton.Visible = p, true);

            JobPrioritiesButton.OnPressed += args =>
            {
                jobPriorityEditor.LoadJobPriorities();
                CharEditor.Visible = false;
                JobPriorityEditor.Visible = true;
            };
        }

        /// <summary>
        /// Disposes and reloads all character picker buttons from the preferences data.
        /// </summary>
        public void ReloadCharacterPickers()
        {
            _createNewCharacterButton.Orphan();
            Characters.DisposeAllChildren();

            var numberOfFullSlots = 0;
            var characterButtonsGroup = new ButtonGroup();

            JobPrioritiesButton.Group = characterButtonsGroup;

            if (!_preferencesManager.ServerDataLoaded)
            {
                return;
            }

            CharEditor.Visible = true;
            JobPriorityEditor.Visible = false;

            _createNewCharacterButton.ToolTip =
                Loc.GetString("character-setup-gui-create-new-character-button-tooltip",
                    ("maxCharacters", _preferencesManager.Settings!.MaxCharacterSlots));

            var first = !SelectedCharacterSlot.HasValue;
            foreach (var (slot, character) in _preferencesManager.Preferences!.Characters)
            {
                var isSelected = SelectedCharacterSlot.HasValue ? slot == SelectedCharacterSlot : first;
                numberOfFullSlots++;
                var characterPickerButton = new CharacterPickerButton(_entManager,
                    _protomanager,
                    characterButtonsGroup,
                    character,
                    isSelected);

                if (isSelected && _humanoidProfileEditor.Profile == null)
                    _humanoidProfileEditor.SetProfile(slot);

                Characters.AddChild(characterPickerButton);

                characterPickerButton.OnPressed += args =>
                {
                    SelectedCharacterSlot = slot;
                    SelectCharacter?.Invoke(slot);
                    CharEditor.Visible = true;
                    JobPriorityEditor.Visible = false;
                    _humanoidProfileEditor.SetProfile(slot);
                };

                characterPickerButton.OnDeletePressed += () =>
                {
                    DeleteCharacter?.Invoke(slot);
                };

                characterPickerButton.OnEnableToggled += pressed =>
                {
                    SetCharacterEnable?.Invoke((slot, pressed));
                };
                if(first)
                    first = false;
            }

            _createNewCharacterButton.Disabled = numberOfFullSlots >= _preferencesManager.Settings.MaxCharacterSlots;
            Characters.AddChild(_createNewCharacterButton);
        }
    }
}
